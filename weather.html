<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport" />
    <meta content="" name="Lustiges aus dem Ticker-Basislager" />
    <meta content="" name="Basislager Services" />
    <title>Basislager-Wetter</title>
    <link href="assets/favicon.png" rel="icon" type="image/x-icon" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      #map {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="index.html">Ticker-Basislager</a>
        <button class="navbar-toggler" data-bs-target="#navbarSupportedContent" data-bs-toggle="collapse" type="button">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="ranking.html">Rangliste</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="postle.html">Postle</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="books.html">Bücher</a>
            </li>
            <!--li class="nav-item">
              <a class="nav-link" href="magnus.html">Magnus</a>
            </li-->
            <li class="nav-item">
              <a class="nav-link active" href="weather.html">Wetter</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="ticker.html" target="_blank">Ticker</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      // Restore a saved view or create a new map.
      const savedView = JSON.parse(localStorage.getItem('mapView'))
      const map = L.map('map').setView(
        savedView ? savedView.center : [47.5162, 14.5501],
        savedView ? savedView.zoom : 7
      )
      // Save view to localStorage on move or zoom
      map.on('moveend zoomend', () => {
        const center = map.getCenter()
        const zoom = map.getZoom()
        localStorage.setItem(
          'mapView',
          JSON.stringify({
            center: [center.lat, center.lng],
            zoom: zoom,
          })
        )
      })

      // Add OSM tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map)

      // Create marker cluster group with custom cluster icon
      const markers = L.markerClusterGroup({
        iconCreateFunction: function (cluster) {
          const temps = cluster.getAllChildMarkers().map((m) => m.options.temp)
          const avg = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)
          return L.divIcon({
            html: `<div style="background: #ff7800; color: white; border-radius: 50%; padding: 10px;">${avg}°C</div>`,
            className: 'custom-cluster',
            iconSize: L.point(40, 40),
          })
        },
      })

      // Get temperature information and add it to the map.
      let stationData = {}
      fetch('https://dataset.api.hub.geosphere.at/v1/station/current/tawes-v1-10min/metadata')
        .then((response) => {
          if (!response.ok) throw new Error('connection error')
          return response.json()
        })
        .then((data) => {
          for (const station of data.stations) {
            // Some stations might be inactive.
            // TODO: Filter out stations with outdated values (e.g. more than 1 hour old).
            if (!station.is_active) continue

            stationData[station.id] = {
              name: station.name,
              altitude: station.altitude,
              lat: station.lat,
              lon: station.lon,
            }
          }
          const idsParam = encodeURIComponent(Object.keys(stationData).join(','))
          const url = `https://dataset.api.hub.geosphere.at/v1/station/current/tawes-v1-10min?parameters=TLAM,FFAM,FFX&station_ids=${idsParam}&output_format=geojson`
          console.log(url)
          return fetch(url)
        })
        .then((response) => {
          if (!response.ok) throw new Error('connection error')
          return response.json()
        })
        .then((data) => {
          for (const station of data.features) {
            const stationId = station.properties.station
            // This seems to be an array with multiple, possibly null values. Just take one for now.
            // If there is no value, then we just delete the station.
            const tempData = station.properties.parameters.TLAM.data
            const tempValue = tempData.filter((v) => v !== null)[0]
            if (typeof tempValue !== 'undefined') {
              stationData[stationId]['temperature'] = tempValue
            } else {
              delete stationData[stationId]
            }
          }
        })
        .then(() => {
          for (const station of Object.values(stationData)) {
            const marker = L.marker([station.lat, station.lon], { temp: station.temperature }).bindPopup(
              `
                <strong>${station.name}</strong>
                <p>${station.temperature}°C</p>
              `
            )
            markers.addLayer(marker)
          }
          map.addLayer(markers)
        })
    </script>
  </body>
</html>
